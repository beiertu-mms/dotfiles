#!/usr/bin/env bash
#===============================================================================
#  DESCRIPTION: Clone a git repo to a folder structure based on the given url.
#
#       PARAMS: 1. (required) The repository url to be cloned.
#               2. (optional) The default base folder. Default: $HOME/data
# REQUIREMENTS: git
#       AUTHOR: tung beier
#      CREATED: 23 November 2022 08:07 CET
#===============================================================================

set -o errexit  # Exit when a command fails
                # Use || true if a command is allowed to fail
set -o nounset  # Treat unset variables as an error
set -o pipefail # Exit when a command in a pipeline fails

RED='\033[0;31m'
NC='\033[0m' # No Color

url=${1:-}
base_folder=${2:-$HOME/data}
# See https://serverfault.com/questions/417241/extract-repository-name-from-github-url-in-bash
git_url_regex="^(https|git)(:\/\/|@)([^\/:]+)[\/:]([^\/:]+)\/(.+)(.git)*$"

if [[ -z $url ]]; then
  echo -e "${RED}expect a git url, but receive none.${NC}"
  exit 1
fi

if [[ ! $url =~ $git_url_regex ]]; then
  echo -e "${RED}receive an invalid url $url.${NC}"
  exit 1
fi

hostname=${BASH_REMATCH[3]}
user=${BASH_REMATCH[4]}
repo=${BASH_REMATCH[5]}

folder="$base_folder/$hostname/$user/${repo%.git}"

echo "creating folder $folder"
mkdir --parents "$folder"

git clone "$url" "$folder"
