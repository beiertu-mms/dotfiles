#!/usr/bin/env bash
#===============================================================================
#
#          FILE: generate-i3-config
#
#         USAGE: ./generate-i3-config
#
#   DESCRIPTION: Generate the configuration file for i3 based on the current host
#
#       OPTIONS: -
#  REQUIREMENTS: cat
#         NOTES: -
#        AUTHOR: tung beier
#       CREATED: 25 August 2020 19:32 CEST
#===============================================================================

set -o errexit  # Exit when a command fails
                # Use || true if a command is allowed to fail
set -o nounset  # Treat unset variables as an error
set -o pipefail # Exit when a command in a pipeline fails

CONFIG_DIR="${HOME}/.config/i3"
CONFIG_FILE="${CONFIG_DIR}/config"
HOST=$(hostname)

#---  SCRIPT LOGIC  ------------------------------------------------------------
# make sure that the configuration directory does exist
if [ ! -d "$CONFIG_DIR" ]; then
  mkdir -p "$CONFIG_DIR"
fi

# delete old config file
if [ -e "$CONFIG_FILE" ]; then
  rm -f "$CONFIG_FILE"
fi

# base info
  cat <<EOF >> "$CONFIG_FILE"
# i3 configuration generated by build-i3-config script
# ----------------------------------------------------
set \$mod Mod4

new_window 1pixel
focus_follows_mouse no
mouse_warping none
hide_edge_borders smart
popup_during_fullscreen smart
focus_on_window_activation urgent

# Gaps
for_window [class="^.*"] border pixel 1
smart_borders on
gaps inner 15
gaps outer -14

# Font
set \$font "JetBrainsMono-Regular"
font pango:\$font 12

# Use Mouse+\$mod to drag floating windows to their wanted position
floating_modifier \$mod

# Terminal
bindsym \$mod+Return exec st

# Kill focused window
bindsym \$mod+Shift+c kill

# Applications launcher
bindsym \$mod+d exec --no-startup-id \$HOME/.config/rofi/rofi

# Change focus
bindsym \$mod+h focus left
bindsym \$mod+j focus down
bindsym \$mod+k focus up
bindsym \$mod+l focus right

# Move focused window
bindsym \$mod+Shift+h move left
bindsym \$mod+Shift+j move down
bindsym \$mod+Shift+k move up
bindsym \$mod+Shift+l move right

# Split in horizontal orientation
bindsym \$mod+Control+v split h

# Split in vertical orientation
bindsym \$mod+Control+h split v

# Enter fullscreen mode for the focused container
bindsym \$mod+f fullscreen toggle

# Change container layout (stacked, tabbed, toggle split)
bindsym \$mod+Control+s layout stacking
bindsym \$mod+Control+t layout tabbed
bindsym \$mod+Control+p layout toggle split

# Toggle tiling / floating
#bindsym \$mod+Shift+f floating toggle

# Change focus between tiling / floating windows
#bindsym \$mod+Shift+space focus mode_toggle

# Focus the parent container
bindsym \$mod+p focus parent

# focus the child container
bindsym \$mod+c focus child

# reload the configuration file
bindsym \$mod+Shift+q reload
# restart i3 inplace (preserves your layout/session, can be used to upgrade i3)
bindsym \$mod+Shift+r restart
# exit i3 (logs you out of your X session)
bindsym \$mod+Shift+period exec "i3-nagbar -t warning -m 'You pressed the exit shortcut. Do you really want to exit i3? This will end your X session.' -b 'Yes, exit i3' 'i3-msg exit'"

# Workspaces
set \$workspace_1 "1:  "
set \$workspace_2 "2:  "
set \$workspace_3 "3:  "
set \$workspace_4 "4:  "
set \$workspace_5 "5:  "
set \$workspace_6 "6:  "
set \$workspace_7 "7:  "
set \$workspace_8 "8:  "
set \$workspace_9 "9:  "
set \$workspace_0 "0:  "

bindsym \$mod+Tab workspace next_on_output
bindsym \$mod+Shift+Tab workspace prev_on_output

# switch to workspace
bindsym \$mod+bracketleft workspace \$workspace_7
bindsym \$mod+braceleft workspace \$workspace_5
bindsym \$mod+braceright workspace \$workspace_3
bindsym \$mod+parenleft workspace \$workspace_1
bindsym \$mod+equal workspace \$workspace_9

bindsym \$mod+asterisk workspace \$workspace_0
bindsym \$mod+parenright workspace \$workspace_2
bindsym \$mod+plus workspace \$workspace_4
bindsym \$mod+bracketright workspace \$workspace_6
bindsym \$mod+exclam workspace \$workspace_8

# move focused container to workspace
bindsym \$mod+Shift+bracketleft move container to workspace \$workspace_7
bindsym \$mod+Shift+braceleft move container to workspace \$workspace_5
bindsym \$mod+Shift+braceright move container to workspace \$workspace_3
bindsym \$mod+Shift+parenleft move container to workspace \$workspace_1
bindsym \$mod+Shift+equal move container to workspace \$workspace_9

bindsym \$mod+Shift+asterisk move container to workspace \$workspace_0
bindsym \$mod+Shift+parenright move container to workspace \$workspace_2
bindsym \$mod+Shift+plus move container to workspace \$workspace_4
bindsym \$mod+Shift+bracketright move container to workspace \$workspace_6
bindsym \$mod+Shift+exclam move container to workspace \$workspace_8

# resize window (you can also use the mouse for that)
mode "resize" {
        bindsym h resize shrink width 10 px or 10 ppt
        bindsym k resize grow height 10 px or 10 ppt
        bindsym j resize shrink height 10 px or 10 ppt
        bindsym l resize grow width 10 px or 10 ppt

        # same bindings, but for the arrow keys
        bindsym Left resize shrink width 10 px or 10 ppt
        bindsym Up resize grow height 10 px or 10 ppt
        bindsym Down resize shrink height 10 px or 10 ppt
        bindsym Right resize grow width 10 px or 10 ppt

        # back to normal: Enter or Escape
        bindsym Return mode "default"
        bindsym Escape mode "default"
}
bindsym \$mod+r mode "resize"

# COLOR
set \$bg_color               #a3be8c
set \$inactive_bg_color      #2e3440
set \$text_color             #2e3440
set \$inactive_text_color    #4c566a
set \$urgent_bg_color        #bf616a
set \$indicator_color        #a3be8c

# Window colors
# state                 border              background          text                 indicator
client.focused          \$bg_color           \$bg_color           \$text_color          \$indicator_color
client.unfocused        \$inactive_bg_color  \$inactive_bg_color  \$inactive_text_color \$indicator_color
client.focused_inactive \$inactive_bg_color  \$inactive_bg_color  \$inactive_text_color \$indicator_color
client.urgent           \$urgent_bg_color    \$urgent_bg_color    \$text_color          \$indicator_color

set \$bar_bg_color       #2e3440
set \$separator_color    #8fbcbb
set \$focused_ws_color   #a3be8c
set \$active_ws_color    #4c566a
set \$inactive_ws_color  #4c566a
set \$urgent_ws_color    #bf616a
set \$text_ws_color      #2e3440

# Lock screen
bindsym \$mod+Control+l exec \$HOME/.local/bin/lockscreen.sh

# Volume control
bindsym \$mod+Up exec --no-startup-id i3volume up
bindsym \$mod+Down exec --no-startup-id i3volume down

# Backlighting control
bindsym \$mod+Left exec --no-startup-id i3backlight down
bindsym \$mod+Right exec --no-startup-id i3backlight up

# Screenshot
bindsym --release \$mod+Shift+s exec scrot \$HOME/downloads/screenshot_%Y-%m-%d_%H%M%S.png -s

assign [class="Chromium"] \$workspace_1

assign [class="St"] \$workspace_0
assign [class="jetbrains-idea"] \$workspace_2
assign [class="DBeaver"] \$workspace_4

EOF

# configuration based on host
case "$HOST" in
  tbe-domdv )
    cat <<EOF >> "$CONFIG_FILE"
# Monitor settings
set \$laptop_monitor DP-2
set \$second_monitor DP-4
set \$third_monitor HDMI-0

workspace \$workspace_1 output \$laptop_monitor
workspace \$workspace_3 output \$laptop_monitor
workspace \$workspace_5 output \$laptop_monitor
workspace \$workspace_7 output \$laptop_monitor
workspace \$workspace_9 output \$second_monitor

workspace \$workspace_0 output \$second_monitor
workspace \$workspace_2 output \$second_monitor
workspace \$workspace_4 output \$second_monitor
workspace \$workspace_6 output \$second_monitor
workspace \$workspace_8 output \$second_monitor

bar {
  font pango:DejaVu Sans Mono, FontAwesome 12
  position top
  status_command i3status-rs \$HOME/.config/i3status-rs/config.toml
  tray_padding 5
  height 30
  colors {
      background  \$bar_bg_color
          separator   \$separator_color
          # state             border              background          text
          focused_workspace   \$focused_ws_color   \$focused_ws_color   \$text_ws_color
          active_workspace    \$active_ws_color    \$active_ws_color    \$text_ws_color
          inactive_workspace  \$inactive_ws_color  \$inactive_ws_color  \$text_ws_color
          urgent_workspace    \$urgent_ws_color    \$urgent_ws_color    \$text_ws_color
  }
  wheel_up_cmd nop
  wheel_down_cmd nop
}

# Num_Lock key -> trigger i3blocks when pressed
bindsym --release 0xff7f  exec pkill -SIGRTMIN+11 i3blocks

# exec xautolock -detectsleep -time 10 -locker \$lock -notify 30 -notifier "Lock screen in 30 seconds"
exec_always --no-startup-id feh --no-fehbg --bg-scale "\$HOME/.config/wallpapers/bg.jpg"

exec --no-startup-id compton -bCG
exec --no-startup-id st
exec --no-startup-id idea.sh
exec --no-startup-id chromium

exec_always --no-startup-id \$HOME/.config/.screenlayout/layout.sh

EOF
    ;;

  node202 )
    cat <<EOF >> "$CONFIG_FILE"
# Monitor settings
set \$primary_monitor DP-4
set \$secondary_monitor DP-0

workspace \$workspace_1 output \$secondary_monitor
workspace \$workspace_3 output \$secondary_monitor
workspace \$workspace_5 output \$secondary_monitor
workspace \$workspace_7 output \$secondary_monitor
workspace \$workspace_9 output \$primary_monitor

workspace \$workspace_0 output \$primary_monitor
workspace \$workspace_2 output \$primary_monitor
workspace \$workspace_4 output \$primary_monitor
workspace \$workspace_6 output \$primary_monitor
workspace \$workspace_8 output \$primary_monitor

bar {
  font pango:DejaVu Sans Mono, FontAwesome 12
  position top
  status_command i3status-rs \$HOME/.config/i3status-rs/config.toml
  tray_padding 5
  height 25
  colors {
      background  \$bar_bg_color
          separator   \$separator_color
          # state             border              background          text
          focused_workspace   \$focused_ws_color   \$focused_ws_color   \$text_ws_color
          active_workspace    \$active_ws_color    \$active_ws_color    \$text_ws_color
          inactive_workspace  \$inactive_ws_color  \$inactive_ws_color  \$text_ws_color
          urgent_workspace    \$urgent_ws_color    \$urgent_ws_color    \$text_ws_color
  }
  wheel_up_cmd nop
  wheel_down_cmd nop
}

# exec xautolock -detectsleep -time 10 -locker \$lock -notify 30 -notifier "Lock screen in 30 seconds"

exec --no-startup-id st
exec --no-startup-id idea.sh
exec --no-startup-id chromium

EOF
    ;;

  *)
    cat <<EOF >> "$CONFIG_FILE"
bar {
  font pango:DejaVu Sans Mono, FontAwesome 12
  position top
  status_command i3status-rs \$HOME/.config/i3status-rs/config.toml
  tray_padding 5
  height 30
  colors {
      background  \$bar_bg_color
          separator   \$separator_color
          # state             border              background          text
          focused_workspace   \$focused_ws_color   \$focused_ws_color   \$text_ws_color
          active_workspace    \$active_ws_color    \$active_ws_color    \$text_ws_color
          inactive_workspace  \$inactive_ws_color  \$inactive_ws_color  \$text_ws_color
          urgent_workspace    \$urgent_ws_color    \$urgent_ws_color    \$text_ws_color
  }
  wheel_up_cmd nop
  wheel_down_cmd nop
}

exec xautolock -detectsleep -time 10 -locker \$lock -notify 30 -notifier "Lock screen in 30 seconds"
exec_always --no-startup-id feh --no-fehbg --bg-fill \$HOME/.config/wallpapers/bg.jpg

exec --no-startup-id compton -CGb
exec --no-startup-id st -e tmux

EOF
    ;;
esac
