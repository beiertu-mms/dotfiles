#!/usr/bin/env bash
#===============================================================================
#
#          FILE: generate-git-aliases.sh
#
#         USAGE: ./generate-git-aliases.sh
#
#   DESCRIPTION: Generate a zsh config file contains git aliases from the
#                git global config file.
#
#  REQUIREMENTS: md5sum
#        AUTHOR: tung beier
#       CREATED: 20 August 2019 20:18 CEST
#===============================================================================

set -o errexit  # Exit when a command fails
                # Use || true if a command is allowed to fail
set -o nounset  # Treat unset variables as an error
set -o pipefail # Exit when a command in a pipeline fails

#---  GLOBAL VARIABLES  --------------------------------------------------------
readonly git_config_file=$HOME/.config/git/config


#---  FUNCTION  ----------------------------------------------------------------
#          NAME: _check_git_config
#   DESCRIPTION: check whether the global git config file has changed and the
#                git alias file has to be re-/generate
#       RETURNS: NO-DOING = if the git config file has not changed
#                GENERATE = if the git config file has never been checked
#                           or it has changed
#-------------------------------------------------------------------------------
_check_git_config() {
  local checksum_folder=$HOME/.config/checksums/
  if [[ ! -d "$checksum_folder" ]]; then
    mkdir -p "$checksum_folder"
  fi

  local checksum_file=$checksum_folder/git-config-checksum.md5
  local check_result

  if [[ ! -f "$checksum_file" ]]; then
    touch "$checksum_file"
    md5sum "$git_config_file" > "$checksum_file"
    echo 'GENERATE'
  else
    check_result=$(md5sum -c --quiet "$checksum_file" 2> /dev/null)

    if [[ -z "$check_result" ]]; then
      echo 'NO-DOING'
    else
      md5sum "$git_config_file" > "$checksum_file"
      echo 'GENERATE'
    fi
  fi
}


#---  FUNCTION  ----------------------------------------------------------------
#          NAME: _generate_alias_file
#   DESCRIPTION: generate and fill the zsh alias file with git aliases
#-------------------------------------------------------------------------------
_generate_alias_file() {
  local alias_file=$HOME/.config/zsh/aliases/git.zsh

  if [[ ! -f "$alias_file" ]]; then
    touch "$alias_file"
  fi

  cat <<EOF > "$alias_file"
#
# Generated by generate-git-aliases.sh
# on the $(date '+%d %B %Y %H:%M %Z')
#
alias g='git'
alias dot="git --git-dir=\$HOME/dotfiles --work-tree=\$HOME"
alias gup="git remote update -p && git merge --ff-only @{u}"

EOF

  local marker=0
  local alias_module_regex="^\[alias\]$"
  local other_module_regex="^\[\w+\]$"
  local special_aliases="^up=.+$"

  while read -r line; do
    if [[ -z "$line" ]]; then
      continue
    fi

    if [[ $line =~ $alias_module_regex ]]; then
      # Found the alias config
      marker=1
    fi

    if [[ "$marker" -eq 1 ]] \
      && [[ ! $line =~ $alias_module_regex ]] \
      && [[ $line =~ $other_module_regex ]]; then
      # Find the next module config
      break
    fi

    if [[ "$marker" -eq 1 ]]; then
      local line_without_first_space="${line/ /}"

      if [[ $line =~ $alias_module_regex ]] \
        || [[ $line_without_first_space =~ $special_aliases ]]; then
        continue
      fi

      local gitAlias="${line_without_first_space/ /\'git }"
      echo "alias g${gitAlias}'" >> "$alias_file"
    fi

  done < "$git_config_file"
}


#---  SCRIPT LOGIC  ------------------------------------------------------------
if [[ ! -f "${git_config_file}" ]]; then
  # There is no config file
  return 0
fi

check_config_file_result=$(_check_git_config)
if [[ "$check_config_file_result" == "GENERATE" ]]; then
  _generate_alias_file
fi

